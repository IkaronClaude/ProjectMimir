# Mimir - Fiesta Online Server Data Toolkit

## Environment

- **Platform**: Windows — use forward slashes (`Z:/path`) or double backslashes (`Z:\\path`) in bash/CLI commands
- **.NET version**: 10.0 (SDK 10.0.102)
- **GitHub**: https://github.com/IkaronClaude/ProjectMimir

## Quick Reference

- **Build**: `dotnet build Mimir.sln`
- **Test**: `dotnet test Mimir.sln`
- **Run CLI**: `dotnet run --project src/Mimir.Cli -- <command>`
- **Import server only**: `dotnet run --project src/Mimir.Cli -- import "Z:/Odin Server Files/Server/9Data" test-project`
- **Import server + client**: `dotnet run --project src/Mimir.Cli -- import "Z:/Odin Server Files/Server/9Data" test-project --client "Z:/Client/Fiesta Online/ressystem"`

## Data Locations

- **Server 9Data**: `Z:/Odin Server Files/Server/9Data/` (~218 SHN + hundreds of .txt)
- **Client ressystem**: `Z:/Client/Fiesta Online/ressystem/` (203 SHN files, no text tables)
- **Overlap**: 118 shared SHN files, 102 server-only, 39 client-only
- Client-only files are mostly UI/text/visual (BasicInfo*, TextData*, FontSet, DamageEffect, etc.)
- `.shd` files in ressystem are height maps / walkability grids, not data tables

## Project Structure

```
src/
  Mimir.Core/          Core models, interfaces, definitions system
  Mimir.Shn/           SHN binary format (encrypted, EUC-KR encoded)
  Mimir.ShineTable/    Text table formats (#table and #DEFINE)
  Mimir.Sql/           SQLite in-memory engine
  Mimir.Cli/           CLI entry point (import/build/query/edit/shell)
tests/
  Mimir.Core.Tests/    DefinitionResolver tests
  Mimir.Shn.Tests/     (empty)
  Mimir.ShineTable.Tests/  Table + Define format round-trip tests
  Mimir.Sql.Tests/     SqlEngine load/extract/edit tests
test-project/          Real imported data (gitignored, ~1234 tables)
```

## Key Conventions

- **Test framework**: xUnit + Shouldly + NSubstitute (Directory.Build.props in tests/)
- **Test files need** `using Xunit;` (not auto-imported via global usings)
- **Format IDs**: `"shn"`, `"shinetable"`, `"configtable"` - never use old names "rawtable"/"rawtable-define"
- **Parser classes**: `ShineTableFormatParser` (#table format), `ConfigTableFormatParser` (#DEFINE format)
- **Definitions file** (`mimir.definitions.json`): Lives at repo root, NOT inside test-project. Searched upward from project dir.
- **SHN encoding**: EUC-KR (code page 949) - never use UTF-8 for SHN string operations
- **SQLite integer handling**: Use `unchecked()` casts for unsigned types (UInt32, UInt64) since SQLite stores everything as Int64
- **JsonElement**: All values from JSON-deserialized project files are `System.Text.Json.JsonElement`, not native types. Convert helpers must handle this.
- **Empty tables must round-trip**: Server exes may require tables to exist even with 0 rows. Parsers must preserve empty tables.
- **Internal classes** in Mimir.ShineTable use `InternalsVisibleTo` for test access.

## Common Pitfalls

1. **Checked overflow**: `Convert.ToUInt32(long)` throws on large values. Use `unchecked((uint)longVal)` instead.
2. **Korean strings**: EUC-KR is 2 bytes/char, UTF-8 is 3 bytes/char for Korean. SHN padded strings overflow if you measure in UTF-8.
3. **JsonElement in write path**: `Convert.ToByte(jsonElement)` doesn't work because JsonElement doesn't implement IConvertible. Must check `is JsonElement je` first and use je.GetXxx().
4. **ConvertFromSqlite**: Must handle `string`, `long`, and `double` value types separately - SQLite returns these native types.
5. **Parser column building**: TableFormatParser builds columns from #columntype/#columnname even with 0 records (not lazily on first record).

## Data Flow

```
Server Files (SHN/txt) → import → JSON project (mimir.json + data/**/*.json)
JSON project → load into SQLite → query/edit → extract back to JSON → build → Server Files
```

## Test-Project Data

The test-project/ dir contains real imported data from `Z:\Odin Server Files\Server\9Data`. It's gitignored and can be regenerated by running the import command. Data directories: `data/shn/`, `data/shinetable/`, `data/configtable/`.
