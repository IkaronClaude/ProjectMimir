# Fiesta Online server — one container per process
# All services communicate via Docker Compose DNS hostnames.
#
# MIMIR_PROJ_DIR env var controls volume mount paths (set automatically by mimir.bat).
# COMPOSE_PROJECT_NAME controls container naming (set by deploy scripts, must be lowercase).
#
# Usage (from inside your project dir):
#   mimir deploy start       — start all containers
#   mimir deploy stop        — stop all containers
#   mimir deploy update      — build + pack + snapshot + restart game servers
#   mimir deploy restart     — snapshot + restart game servers (skip build)
#   mimir deploy rebuild-game — rebuild game image + start (excludes SQL)
#   mimir deploy rebuild-sql  — wipe SQL data + restore from .bak (destructive!)

# Add KEEP_ALIVE=1 to any service's environment to keep the container alive after
# the game process stops (disables auto-exit, lets you 'docker exec' to investigate).
# Example:
#   zone00:
#     <<: *gameserver
#     environment:
#       - PROCESS_NAME=Zone00
#       - PROCESS_EXE=Zone.exe
#       - ZONE_NUMBER=0
#       - KEEP_ALIVE=1

x-gameserver: &gameserver
  build:
    context: .
    dockerfile: Dockerfile.server
  volumes:
    - ${MIMIR_PROJ_DIR}/deployed/server:C:/server/9Data

services:
  sqlserver:
    build:
      context: .
      dockerfile: Dockerfile.sql
    ports:
      - "1433:1433"
    volumes:
      - sql-data:C:/sql-data
    environment:
      - SA_PASSWORD=${SA_PASSWORD:-V63WsdafLJT9NDAn}
      - ACCEPT_EULA=Y
    healthcheck:
      test: ["CMD", "sqlcmd", "-S", ".\\SQLEXPRESS", "-U", "sa", "-P", "${SA_PASSWORD:-V63WsdafLJT9NDAn}", "-C", "-Q", "SELECT 1"]
      interval: 10s
      timeout: 5s
      retries: 10
      start_period: 30s

  # --- DB bridge processes (depend on SQL) ---

  account:
    <<: *gameserver
    environment:
      - PROCESS_NAME=Account
      - PROCESS_EXE=Account.exe
    depends_on:
      sqlserver:
        condition: service_healthy

  accountlog:
    <<: *gameserver
    environment:
      - PROCESS_NAME=AccountLog
      - PROCESS_EXE=AccountLog.exe
    depends_on:
      sqlserver:
        condition: service_healthy

  character:
    <<: *gameserver
    environment:
      - PROCESS_NAME=Character
      - PROCESS_EXE=Character.exe
    depends_on:
      sqlserver:
        condition: service_healthy

  gamelog:
    <<: *gameserver
    environment:
      - PROCESS_NAME=GameLog
      - PROCESS_EXE=GameLog.exe
    depends_on:
      sqlserver:
        condition: service_healthy

  # --- Game processes (depend on DB bridges) ---

  login:
    <<: *gameserver
    ports:
      - "9010:9010"    # Client connects here
    environment:
      - PROCESS_NAME=Login
      - PROCESS_EXE=Login.exe
    depends_on:
      account:
        condition: service_started
      accountlog:
        condition: service_started
      character:
        condition: service_started
      gamelog:
        condition: service_started

  worldmanager:
    <<: *gameserver
    ports:
      - "9013:9013"
    environment:
      - PROCESS_NAME=WorldManager
      - PROCESS_EXE=WorldManager.exe
    depends_on:
      account:
        condition: service_started
      accountlog:
        condition: service_started
      character:
        condition: service_started
      gamelog:
        condition: service_started

  # --- Zone processes (depend on WorldManager) ---

  zone00:
    <<: *gameserver
    ports:
      - "9016:9016"
    environment:
      - PROCESS_NAME=Zone00
      - PROCESS_EXE=Zone.exe
      - ZONE_NUMBER=0
    depends_on:
      worldmanager:
        condition: service_started

  zone01:
    <<: *gameserver
    ports:
      - "9019:9019"
    environment:
      - PROCESS_NAME=Zone01
      - PROCESS_EXE=Zone.exe
      - ZONE_NUMBER=1
    depends_on:
      worldmanager:
        condition: service_started

  zone02:
    <<: *gameserver
    ports:
      - "9022:9022"
    environment:
      - PROCESS_NAME=Zone02
      - PROCESS_EXE=Zone.exe
      - ZONE_NUMBER=2
    depends_on:
      worldmanager:
        condition: service_started

  zone03:
    <<: *gameserver
    ports:
      - "9025:9025"
    environment:
      - PROCESS_NAME=Zone03
      - PROCESS_EXE=Zone.exe
      - ZONE_NUMBER=3
    depends_on:
      worldmanager:
        condition: service_started

  zone04:
    <<: *gameserver
    ports:
      - "9028:9028"
    environment:
      - PROCESS_NAME=Zone04
      - PROCESS_EXE=Zone.exe
      - ZONE_NUMBER=4
    depends_on:
      worldmanager:
        condition: service_started

  # --- Optional patch server (profile: patch) ---
  # Start with: docker compose --profile patch up -d
  # Or use start.bat which includes it automatically.
  patch-server:
    build:
      context: .
      dockerfile: Dockerfile.patch
    profiles: [patch]
    ports:
      - "8080:80"
    volumes:
      - ${MIMIR_PROJ_DIR}/patches:C:/patches:ro
    restart: unless-stopped

  api:
    profiles: [api]
    build:
      context: .
      dockerfile: Dockerfile.api
    ports:
      - "5000:5000"
    environment:
      - ACCOUNT_CONN=Server=sqlserver\SQLEXPRESS;Database=Account;User Id=sa;Password=${SA_PASSWORD:-V63WsdafLJT9NDAn};TrustServerCertificate=True;
      - CHARACTER_CONN=Server=sqlserver\SQLEXPRESS;Database=${WORLD_DB_NAME:-World00_Character};User Id=sa;Password=${SA_PASSWORD:-V63WsdafLJT9NDAn};TrustServerCertificate=True;
      - JWT_SECRET=${JWT_SECRET:-dev-secret-change-in-prod-must-be-long-enough}
      - ADMIN_KEY=${ADMIN_KEY:-dev-admin-key}
    depends_on:
      sqlserver:
        condition: service_healthy

volumes:
  sql-data:
