# Fiesta Online server — one container per process
# All services communicate via Docker Compose DNS hostnames.
#
# MIMIR_PROJ_DIR env var controls volume mount paths (set automatically by mimir.bat).
# COMPOSE_PROJECT_NAME controls container naming (set by deploy scripts, must be lowercase).
#
# Usage (from inside your project dir):
#   mimir deploy start       — start all containers
#   mimir deploy stop        — stop all containers
#   mimir deploy update      — build + pack + snapshot + restart game servers
#   mimir deploy restart     — snapshot + restart game servers (skip build)
#   mimir deploy rebuild-game — rebuild game image + start (excludes SQL)
#   mimir deploy rebuild-sql  — wipe SQL data + restore from .bak (destructive!)

# Set KEEP_ALIVE=1 in .mimir-deploy.env to keep all game containers alive after
# their process stops (disables auto-exit, lets you 'docker exec' to investigate).
# Usage: mimir deploy set KEEP_ALIVE 1 && mimir deploy rebuild-game

x-gameserver: &gameserver
  build:
    context: .
    dockerfile: Dockerfile.server
  volumes:
    - ${MIMIR_PROJ_DIR}/deployed/server:C:/server/9Data
  # NOTE: 'environment' is overridden per-service because YAML merge is shallow.
  # SA_PASSWORD and KEEP_ALIVE must be included in each service's environment list.

services:
  sqlserver:
    build:
      context: .
      dockerfile: Dockerfile.sql
    ports:
      - "1433:1433"
    volumes:
      - sql-data:C:/sql-data
    environment:
      - "SA_PASSWORD=${SA_PASSWORD:?SA_PASSWORD not set. Run: mimir deploy set SA_PASSWORD YourStrongPassword1}"
      - ACCEPT_EULA=Y
    healthcheck:
      test: ["CMD", "sqlcmd", "-S", ".\\SQLEXPRESS", "-E", "-C", "-Q", "SELECT 1"]
      interval: 10s
      timeout: 5s
      retries: 10
      start_period: 30s

  # --- DB bridge processes (depend on SQL) ---

  account:
    <<: *gameserver
    environment:
      - "SA_PASSWORD=${SA_PASSWORD:?SA_PASSWORD not set. Run: mimir deploy set SA_PASSWORD YourStrongPassword1}"
      - "KEEP_ALIVE=${KEEP_ALIVE:-0}"
      - PROCESS_NAME=Account
      - PROCESS_EXE=Account.exe
    depends_on:
      sqlserver:
        condition: service_healthy

  accountlog:
    <<: *gameserver
    environment:
      - "SA_PASSWORD=${SA_PASSWORD:?SA_PASSWORD not set. Run: mimir deploy set SA_PASSWORD YourStrongPassword1}"
      - "KEEP_ALIVE=${KEEP_ALIVE:-0}"
      - PROCESS_NAME=AccountLog
      - PROCESS_EXE=AccountLog.exe
    depends_on:
      sqlserver:
        condition: service_healthy

  character:
    <<: *gameserver
    environment:
      - "SA_PASSWORD=${SA_PASSWORD:?SA_PASSWORD not set. Run: mimir deploy set SA_PASSWORD YourStrongPassword1}"
      - "KEEP_ALIVE=${KEEP_ALIVE:-0}"
      - PROCESS_NAME=Character
      - PROCESS_EXE=Character.exe
    depends_on:
      sqlserver:
        condition: service_healthy

  gamelog:
    <<: *gameserver
    environment:
      - "SA_PASSWORD=${SA_PASSWORD:?SA_PASSWORD not set. Run: mimir deploy set SA_PASSWORD YourStrongPassword1}"
      - "KEEP_ALIVE=${KEEP_ALIVE:-0}"
      - PROCESS_NAME=GameLog
      - PROCESS_EXE=GameLog.exe
    depends_on:
      sqlserver:
        condition: service_healthy

  # --- Game processes (depend on DB bridges) ---

  login:
    <<: *gameserver
    ports:
      - "9010:9010"    # Client connects here
    environment:
      - "SA_PASSWORD=${SA_PASSWORD:?SA_PASSWORD not set. Run: mimir deploy set SA_PASSWORD YourStrongPassword1}"
      - "KEEP_ALIVE=${KEEP_ALIVE:-0}"
      - PROCESS_NAME=Login
      - PROCESS_EXE=Login.exe
    depends_on:
      account:
        condition: service_started
      accountlog:
        condition: service_started
      character:
        condition: service_started
      gamelog:
        condition: service_started

  worldmanager:
    <<: *gameserver
    ports:
      - "9013:9013"
    environment:
      - "SA_PASSWORD=${SA_PASSWORD:?SA_PASSWORD not set. Run: mimir deploy set SA_PASSWORD YourStrongPassword1}"
      - "KEEP_ALIVE=${KEEP_ALIVE:-0}"
      - PROCESS_NAME=WorldManager
      - PROCESS_EXE=WorldManager.exe
    depends_on:
      account:
        condition: service_started
      accountlog:
        condition: service_started
      character:
        condition: service_started
      gamelog:
        condition: service_started

  # --- Zone processes (depend on WorldManager) ---

  zone00:
    <<: *gameserver
    ports:
      - "9016:9016"
    environment:
      - "SA_PASSWORD=${SA_PASSWORD:?SA_PASSWORD not set. Run: mimir deploy set SA_PASSWORD YourStrongPassword1}"
      - "KEEP_ALIVE=${KEEP_ALIVE:-0}"
      - PROCESS_NAME=Zone00
      - PROCESS_EXE=Zone.exe
      - ZONE_NUMBER=0
    depends_on:
      worldmanager:
        condition: service_started

  zone01:
    <<: *gameserver
    ports:
      - "9019:9019"
    environment:
      - "SA_PASSWORD=${SA_PASSWORD:?SA_PASSWORD not set. Run: mimir deploy set SA_PASSWORD YourStrongPassword1}"
      - "KEEP_ALIVE=${KEEP_ALIVE:-0}"
      - PROCESS_NAME=Zone01
      - PROCESS_EXE=Zone.exe
      - ZONE_NUMBER=1
    depends_on:
      worldmanager:
        condition: service_started

  zone02:
    <<: *gameserver
    ports:
      - "9022:9022"
    environment:
      - "SA_PASSWORD=${SA_PASSWORD:?SA_PASSWORD not set. Run: mimir deploy set SA_PASSWORD YourStrongPassword1}"
      - "KEEP_ALIVE=${KEEP_ALIVE:-0}"
      - PROCESS_NAME=Zone02
      - PROCESS_EXE=Zone.exe
      - ZONE_NUMBER=2
    depends_on:
      worldmanager:
        condition: service_started

  zone03:
    <<: *gameserver
    ports:
      - "9025:9025"
    environment:
      - "SA_PASSWORD=${SA_PASSWORD:?SA_PASSWORD not set. Run: mimir deploy set SA_PASSWORD YourStrongPassword1}"
      - "KEEP_ALIVE=${KEEP_ALIVE:-0}"
      - PROCESS_NAME=Zone03
      - PROCESS_EXE=Zone.exe
      - ZONE_NUMBER=3
    depends_on:
      worldmanager:
        condition: service_started

  zone04:
    <<: *gameserver
    ports:
      - "9028:9028"
    environment:
      - "SA_PASSWORD=${SA_PASSWORD:?SA_PASSWORD not set. Run: mimir deploy set SA_PASSWORD YourStrongPassword1}"
      - "KEEP_ALIVE=${KEEP_ALIVE:-0}"
      - PROCESS_NAME=Zone04
      - PROCESS_EXE=Zone.exe
      - ZONE_NUMBER=4
    depends_on:
      worldmanager:
        condition: service_started

  # --- Optional patch server (profile: patch) ---
  # Start with: docker compose --profile patch up -d
  # Or use start.bat which includes it automatically.
  patch-server:
    build:
      context: .
      dockerfile: Dockerfile.patch
    profiles: [patch]
    ports:
      - "8080:80"
    volumes:
      - ${MIMIR_PROJ_DIR}/patches:C:/patches:ro
    restart: unless-stopped

  api:
    profiles: [api]
    build:
      context: .
      dockerfile: Dockerfile.api
    ports:
      - "5000:5000"
    environment:
      - "ACCOUNT_CONN=Server=sqlserver\\SQLEXPRESS;Database=Account;User Id=sa;Password=${SA_PASSWORD:?SA_PASSWORD not set. Run: mimir deploy set SA_PASSWORD YourStrongPassword1};TrustServerCertificate=True;"
      - "CHARACTER_CONN=Server=sqlserver\\SQLEXPRESS;Database=${WORLD_DB_NAME:-World00_Character};User Id=sa;Password=${SA_PASSWORD:?SA_PASSWORD not set. Run: mimir deploy set SA_PASSWORD YourStrongPassword1};TrustServerCertificate=True;"
      - "JWT_SECRET=${JWT_SECRET:-dev-secret-change-in-prod-must-be-long-enough}"
      - "ADMIN_KEY=${ADMIN_KEY:-dev-admin-key}"
      - "CORS_ORIGINS=${CORS_ORIGINS:-}"
      - "TURNSTILE_SECRET=${TURNSTILE_SECRET:-}"
      - "TURNSTILE_SITE_KEY=${TURNSTILE_SITE_KEY:-}"
      - "RECAPTCHA_SECRET=${RECAPTCHA_SECRET:-}"
      - "RECAPTCHA_SITE_KEY=${RECAPTCHA_SITE_KEY:-}"
      - "HTTPS_CERT_PATH=${HTTPS_CERT_PATH:-}"
      - "HTTPS_CERT_PASSWORD=${HTTPS_CERT_PASSWORD:-}"
    volumes:
      - ${CERT_DIR:-./certs}:C:/certs
    depends_on:
      sqlserver:
        condition: service_healthy

  webapp:
    build:
      context: ${WEBAPP_CONTEXT:-.}
      dockerfile: ${WEBAPP_DOCKERFILE:-Dockerfile.webapp}
    profiles: [webapp]
    ports:
      - "${WEBAPP_PORT:-80}:8080"
    environment:
      - "API_URL=${API_URL:-http://api:5000}"
      - "HTTPS_CERT_PATH=${HTTPS_CERT_PATH:-}"
      - "HTTPS_CERT_PASSWORD=${HTTPS_CERT_PASSWORD:-}"
    volumes:
      - ${CERT_DIR:-./certs}:C:/certs

  # --- CI/CD webhook listener (profile: ci) ---
  # Triggered by GitHub push webhook; runs git pull + mimir build + docker restart.
  # Requires: mimir deploy set WEBHOOK_SECRET=<your-github-secret>
  # GitHub: repo Settings -> Webhooks -> Payload URL: http://<server>:9000/webhook
  ci:
    build:
      context: .
      dockerfile: Dockerfile.ci
    profiles: [ci]
    ports:
      - "${CI_PORT:-9000}:9000"
    volumes:
      - "${MIMIR_PROJ_DIR}:C:/project"
      - "${CI_SSH_DIR:-./ci-ssh}:C:/ssh:ro"
      - type: npipe
        source: \\.\pipe\docker_engine
        target: \\.\pipe\docker_engine
    environment:
      - "WEBHOOK_SECRET=${WEBHOOK_SECRET:-}"
      - "WEBHOOK_BRANCH=${WEBHOOK_BRANCH:-master}"
      - "PROJ_DIR=C:/project"
      - "COMPOSE_PROJECT=${COMPOSE_PROJECT_NAME:-}"
      - "PACK_ENABLED=${PACK_ENABLED:-false}"
      - "RESTART_SERVICES=${RESTART_SERVICES:-login worldmanager zone00 zone01 zone02 zone03 zone04 account accountlog character gamelog}"
      - "GIT_SSH_COMMAND=ssh -i C:/ssh/id_deploy -o StrictHostKeyChecking=no -o UserKnownHostsFile=/dev/null"
    restart: unless-stopped

volumes:
  sql-data:
